#               ,@\.                               I Love Illya Forever!                                               
#             ,@\o@^                                                                                  .]].              
#            =@/oo/@.                             ..]]]]]]]]]]]]]]]]`...                            .@\o/@`            
#           =@/oo/.@`                     .]]@/[[........................,[[@@]]`.                  //oooo/@.          
#          ,@\oo/..=\               .]/@[..........................................[\\].           ,@/..ooo/@.         
#          =@ooo^...@^          .]@[........*.........................................,@@@\`       =^....OOo\^         
#          @^o/[^...=\       .//`......]@[...................................................[@].  =^.......=@.        
#          @^/.......@.    ,@`......,@`........................................................*.[@/^........@.        
#          ,@^.......=\  ,@^...`..,@`................]O]..........................................*.\`.......@.        
#           ,@`.......@./@O^/[...=/.............*.,O@@OO@`......................,\......].....,@`...*,@`....=^         
#.]]`..       \\......=@@O@@.*..//.............../@@@@@@@............*.\.......*..\`.....\\......\\..*.\^..=/          
#\^oo/..[[\@]]`.[@`...=@@@OO^.=@/..............,@/Oooo.=@.......,.....*.@`......*..@.....*,@.....*.@`.*.@\@` .,]]]@@@@@
#.@\ooo]........,[@@\`.@OOOOO/@@.......*......=@\OO/..,]@]].....@........@.........\^......,@...\`..\^..,@/[`....../o/@
#  ,@\\^..............@@OOOOOO@........=^....=@/OO,/`...@^......@........=^.......,/@@@]]...\@\..,\..\^..\\......[o//@`
#    .,[@\]]....,]]/@@@@OOOOO@`.......=^..*./@oO^.......=@.**...=^........@ ......./^....,[.=@OO..,^..@`.=@.....,/@[.  
#      ,@[[`,/OOO@/\@OOOO@@O@^........@....=@/O`.@..@.=^,@@`.....@......./@..****. @O`.....,@/@OO^.\`.=\..@@@@OO@\`    
#    .@`../OOOO@/ .@O@OOOOOO@........=/....@oO]@@@@@@@@@@@@@O]...,\..../O@@`.....,@@O^.*]/O@`,o@OO^=^.=@..=@OOO@`.,@`  
#   ,@...@OOOO/.  =@OO@OOOO@^........=^...=@/@@@@@@@@@@@@@@/@@OO\`,\/OOO@@O^..]OO@@@OOOO@@@@\@,\@OO`@./@..=@@OOOO\..=\ 
#   @^../OOO@`    =@OOOO@@@@.........=^.*.=\//[....@@@@@\...,O@@OOOO@O@@\@OOOOO@/=OO@@@@@@@@@@@@\@OO@O@^..=/ ,@OOO@..\^
#   @^.,@OO@.     =@^=OO@,O@......*`.=@.*.@O...... @@@@@@......[O@@@/`..O\@O@/`..........@@@@/@/@@O@O@@`*.=^  .\@O@^.=@
#   =@.,@O@^      ,@`.\@`o@^......=O^.@`*.@^..=@..,@@@@@@............................@...@@@@@..=O@@@O/...=^    =@@^.=^
#    ,@`=@@.       @..=@,o@^......=@O\,@..@^..=@@\/@@@@@@...........................=@`,`@@@@@....@@@O....=^    .@@`=/ 
#      ,\@@.       @..,@.\@^.......\@@O`\`=\..=@@@@@@@@@@...........................=@@@@@@@@@^...@@/.....=^     =\@`  
#                  @...\@o@^........OOO@@`\@`.,@@@@@@\,@^...........................=@@O@O@@@@....@@`...]`=^           
#                 =/.=^=O@@^....=^...OO@OoO[...\^=@@@\/@`............................@@@@@^=@^....=^..,O@^=^           
#                ,@..=^=OO@^....=\....\@@^.......,`,[..,`............................=^,@\@@@..../^,/OO@/..\           
#               //...=^=OO@@,]`..@.....=@OOooooooOO`............................................[@@@@OO`...@`          
#             ,@`*...@./OOO@/.\\.=^.....\\O,[\o/[`.............@@@@@@@@@@@@@\`............,OOOOOOOO^@OO....=^          
#            =/,/@@@@@/OO@/...O@..@`.....@/O\...................,@@OOOOOOO@@`..............,\OOOOO`/@OO...*.@.         
#           .@[./@/\/@\],@`./@@/[@.@....*.@@@@OOo]`...................`.........................,/@@OOO...*.@^         
#   ./@@@@\]@./^=^.,@@[\@\,@/.../@..@`...*.\@@@@@@@@@@@OO\]]..............................,]/@@@@@@@OOO.@.*.@^         
#    ,@\`..=@.@//`]`,`*@@@^=@@@@@OO`.=\...*.=\=ooooo]o\@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@[`@\ooo/@@@@@@@OO/.@.*.@^         
#      .O@@@@^\@\@O*,@@@@@^.@]]/@@@OO`.\`..*.=@@@@@\,[oooo\/\@O\OOOOO[@@/o\oooo[@OOO/,@\OOOo@@@@@@@OOO^=^..=^          
#     .\\]]]]@\,\@\/@OOO@`,@OOOO@@OOOOO\,@....\@..=/@`.....,[[\/@OO@@\/ooo[`/@@@@\@\@//Ooo\@@@@@@@@OOO,@../^           
#         ../^.\@\]]`.,]/@@OOOOOOO@@OOOOO`\`*./@/@.,@@\....,]@@@@^.*=@\]....@\...=\\@oOo\@@@@@@@@@OO/,@`//.            
#           \@@[       =@@@@@O@/\@@//\@OOOO^,O@@@\@OoOOO@Ooooo\@/[/[\\/OO@@@@/O@@@\o\\@@[@OO@@@@OOO\@@@`               
#                       ,@@@@`./^.....,/@@@O@@\@@@Ooooo\@=///`.,O**.\`,\@@oo\@@@@@Oooo\@`=@@@OOO@@[.                   
#                        .\@@@@`.....]ooo\\@@`@@OOooooo=@\\@\]OOO^**.=@\]@OoO@`\@@OO///./`,@/`.                        
#                         @[[@.]]]Ooo/o]@@@\`@@OOOooooo@^oooooOOOO@@OOO/@\ooO@\@\@@@[]@[....@`                         
#                         =\..[@@@@@[o][\/@@@@OOOoOOOoo\\oooooooooooooo=@oooO@@\@@@[\o]......\\]`                      
#                          .\@@@@@@,\@@OOOooooooooOO@@@@@Ooooooooooooo\@OOOOO@@@\o\/[@@@]O\..]]/@`                     
#                           =@O]@/,[]/\oooooOOOO@@@OOooooo/OoOoo@ooOOOOoo\/@@Oooo/O@@]^\`.[@@^                         
#                          =@OO@@@@\/@@@@@@OOO\/@\oooooooooooo\@@\oooooooooo/@@Oooooo\O@O@`                            
#                         .@OOOO@@/[@@@@@@@....@^oooooooooo/\@//.@\\ooooooooo^@^/O@@@@@@@@O].                          
#                     =/[\/@@[`       ,@@@@\]]]/@/oooooo\@@/\/....,@@/oooooooo/@.@@@@@@@@OOOOO`                        
#                    ,@[]`@/.            .@@@@@@@@@@@@@@]]O@@`.....].\]/[@@@@/[]@@@@@/[[[[[[[..                        
#                      . [/`              .@OO@\/@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@`.                                   
#                                         .\@[[\@OOO@O@@@@/[//[@/[\@@@@/@@/\@O@.                                       
#                                                .\@OOOOO@@OO@\     ,@O@@OO@@OO@@\@                                    
#                                                   ,[\[[[`.          .[\@OOOOO@^/^                                    
#                                                                         ,@]]@@O@^                                    

'full-automatic FGO script'
__auther__='hgjazhgj'

import time
import os
import numpy
import cv2
import win32con
import win32ui
import win32gui
import winsound

from fgo_shell import *

slnPath='E:/VisualStudioDocs/fgo_py/'
scale=1.25
hWnd=win32gui.FindWindowEx(win32gui.FindWindow(None,'BlueStacks App Player'),None,None,None)#'BlueStacks Android PluginAndroid'

IMG_APEMPTY=cv2.imread(slnPath+'asserts/apempty.png')
IMG_ATTACK=cv2.imread(slnPath+'asserts/attack.png')
IMG_BEGIN=cv2.imread(slnPath+'asserts/begin.png')
IMG_BOUND=cv2.imread(slnPath+'asserts/bound.png')
IMG_BOUNDUP=cv2.imread(slnPath+'asserts/boundup.png')
IMG_CARDSEALED=cv2.imread(slnPath+'asserts/cardsealed.png')
IMG_CHOOSEFRIEND=cv2.imread(slnPath+'asserts/choosefriend.png')
IMG_END=cv2.imread(slnPath+'asserts/end.png')
IMG_FAILED=cv2.imread(slnPath+'asserts/failed.png')
IMG_FRIEND=[[file[:-4],cv2.imread(slnPath+'asserts/friend/'+file)]for file in os.listdir(slnPath+'asserts/friend')if file.endswith('.png')]
IMG_HOUGUSEALED=cv2.imread(slnPath+'asserts/hougusealed.png')
IMG_NOFRIEND=cv2.imread(slnPath+'asserts/nofriend.png')
IMG_STILL=cv2.imread(slnPath+'asserts/still.png')
IMG_STAGE=[cv2.imread(slnPath+'asserts/stage/'+file)for file in os.listdir(slnPath+'asserts/stage')if file.endswith('.png')]

friendPos=4
skillInfo=[[[4,0,0],[4,0,0],[4,0,0]],[[4,0,0],[4,0,0],[4,0,0]],[[4,0,0],[4,0,0],[4,0,0]],[[4,0,0],[4,0,0],[4,0,0]],[[4,0,0],[4,0,0],[4,0,0]],[[4,0,0],[4,0,0],[4,0,0]]]
#skillInfo=[#minstage,minstageturn,obj
#    [[1,2,0],[1,0,0],[4,0,0]],
#    [[1,0,0],[1,0,0],[1,0,0]],
#    [[1,0,0],[1,0,0],[3,3,0]],
#    [[4,0,0],[4,0,0],[4,0,0]],
#    [[4,0,0],[4,0,0],[4,0,0]],
#    [[4,0,0],[4,0,0],[4,0,0]]]
#houguInfo=[[1,0],[1,0],[1,0],[1,1],[1,1],[1,1]]#minstage,priority
houguInfo=[[2,1],[3,1],[3,1],[1,1],[1,1],[1,1]]#minstage,priority
houguInfo[friendPos]=[3,0]

def rangeInf(start=0,step=1):
    i=start
    while True:
        yield i
        i+=step
class Fuse(object):
    def __init__(self,fv=300):
        self.__value=0
        self.__max=fv
    @property
    def value():
        return self.__value
    def increase(self):
        self.__value+=1
        if self.__value>self.__max:
            print('Fused',getTime())
            beep()
            exit(0)
    def reset(self):
        self.__value=0
        return True
    def show(self):
        print(self.__value,'/',self.__max,sep='',flush=True)
fuse=Fuse()
def rgb2hsv(x):
    '''
    R,G,B:[0,255]
    H:[0,359]
    S,V:[0,100]
    '''
    R=int(x[2])
    G=int(x[1])
    B=int(x[0])
    cmax=max(R,G,B)
    delta=cmax-min(R,G,B)
    H=0if delta==0else((G-B)/delta if R==cmax else(B-R)/delta+2if G==cmax else(R-G)/delta+4)*60%360
    S=0if cmax==0else delta/cmax
    V=cmax
    return(int(H),int(100*S),int(V*100/255))
def press(c):
    tap(*{
        '\x09':(1800,304),#tab VK_TAB
        '\x12':(960,943),#alt VK_MENU
        ' ':(1820,1030),
        '0':(70,69),
        '1':(277,640),
        '2':(648,640),
        '3':(974,640),
        '4':(1262,640),
        '5':(1651,640),
        '6':(646,304),
        '7':(976,304),
        '8':(1267,304),
        'A':(109,860),
        'B':(1680,368),
        'C':(845,540),
        'D':(385,860),
        'E':(1493,470),
        'F':(582,860),
        'G':(724,860),
        'H':(861,860),
        'J':(1056,860),
        'K':(1201,860),
        'L':(1336,860),
        'N':(248,1041),
        'P':(1854,69),
        'Q':(1800,475),
        'R':(1626,475),
        'S':(244,860),
        'V':(1105,540),
        'W':(1360,475),
        'X':(259,932),
        '\xA0':(41,197),# VK_LSHIFT
        '\xA1':(41,197),# VK_RSHIFT
        '\xBA':(1247,197),#; VK_OEM_1
        '\xBB':(791,69),#+= VK_OEM_PLUS
        '\xBD':(427,69),#-_ VK_OEM_MINUS
    }[c])
def doit(touch,wait):
    for i in range(len(touch)):
        press(touch[i])
        time.sleep(wait[i]/1000)
def beep():
    winsound.PlaySound('SystemHand',0)
def show(img):
    cv2.imshow('imshow',img)
    cv2.waitKey()
    cv2.destroyAllWindows()
def windowCapture(hWnd=hWnd):
    hWndDC=win32gui.GetWindowDC(hWnd)
    left,top,right,bot=win32gui.GetWindowRect(hWnd)
    width=int((right-left)*scale+.001)
    height=int((bot-top)*scale+.001)
    mfcDC=win32ui.CreateDCFromHandle(hWndDC)
    saveDC=mfcDC.CreateCompatibleDC()
    saveBitMap=win32ui.CreateBitmap()
    saveBitMap.CreateCompatibleBitmap(mfcDC,width,height)
    saveDC.SelectObject(saveBitMap)
    saveDC.BitBlt((0, 0),(width,height),mfcDC,(0,0),win32con.SRCCOPY)
    img=numpy.frombuffer(saveBitMap.GetBitmapBits(True),dtype='uint8').reshape(height,width,4)[:,:,0:3]
    win32gui.DeleteObject(saveBitMap.GetHandle())
    saveDC.DeleteDC()
    mfcDC.DeleteDC()
    win32gui.ReleaseDC(hWnd,hWndDC)
    return img
def playSound(file=slnPath+'sound/default.wav',flag=winsound.SND_LOOP|winsound.SND_ASYNC):
    winsound.PlaySound(file,flag)
    os.system('pause')
    winsound.PlaySound(None,0)
def getTime():
    return time.strftime('%Y-%m-%d_%H.%M.%S',time.localtime())

class Check(object):
    def __init__(self):
        fuse.increase()
        #screenShot(name='chk')
        #self.im=cv2.imread(slnPath+'ScreenShots/chk.png')[0:1080,dpx:dpx+1920]
        time.sleep(.08)
        self.im=cv2.resize(windowCapture(),(1920,1080),interpolation=cv2.INTER_CUBIC)
    def compare(self,img,rect=(0,0,1920,1080),delta=.03):
        return cv2.minMaxLoc(cv2.matchTemplate(self.im[rect[1]:rect[3],rect[0]:rect[2]],img,cv2.TM_SQDIFF_NORMED))[0]<delta
    def select(self,img,rect=(0,0,1920,1080)):
        return (lambda x:x.index(min(x)))([cv2.minMaxLoc(cv2.matchTemplate(self.im[rect[1]:rect[3],rect[0]:rect[2]],i,cv2.TM_SQDIFF_NORMED))[0]for i in img])
    def tapOnCmp(self,img,rect=(0,0,1920,1080),delta=.03):
        loc=cv2.minMaxLoc(cv2.matchTemplate(self.im[rect[1]:rect[3],rect[0]:rect[2]],img,cv2.TM_SQDIFF_NORMED))
        if loc[0]>=delta:
            return False
        tap(rect[0]+loc[2][0]+img.shape[1]//2,rect[1]+loc[2][1]+img.shape[0]//2)
        time.sleep(.5)
        return fuse.reset()
    def save(self,name=''):
        cv2.imwrite(slnPath+'ScreenShots/'+(getTime()+'.png'if name==''else name),self.im)
        return self
    def isTurnBegin(self):
        return self.compare(IMG_ATTACK,(1567,932,1835,1064))and fuse.reset()
    def isBattleOver(self):
        return(self.compare(IMG_BOUND,(95,235,460,318))or self.compare(IMG_BOUNDUP,(978,517,1491,596),.06))and fuse.reset()
    def isBegin(self):
        return self.compare(IMG_BEGIN,(1630,950,1919,1079))and fuse.reset()
    def isHouguReady(self):
        return[rgb2hsv(self.im[1002][290+480*i])[1]>5for i in range(3)]
    def isHouguSealed(self):
        return[any([self.compare(j,(470+346*i,258,768+346*i,387),.3)for j in(IMG_HOUGUSEALED,IMG_CARDSEALED)])for i in range(3)]
    def isSkillReady(self):
        return[[not self.compare(IMG_STILL,(65+480*i+141*j,895,107+480*i+141*j,927),.06)for j in range(3)]for i in range(3)]
    def isApEmpty(self):
        return self.compare(IMG_APEMPTY,(800,50,1120,146))and fuse.reset()
    def isChooseFriend(self):
        return self.compare(IMG_CHOOSEFRIEND,(1628,314,1772,390))and fuse.reset()
    def isNoFriend(self):
        return self.compare(IMG_NOFRIEND,(369,545,1552,797),.1)and fuse.reset()
    def getABQ(self):
        return[-1if self.compare(IMG_CARDSEALED,(43+386*i,667,345+386*i,845),.3)else(lambda x:x.index(max(x)))((lambda x:[int(numpy.mean([j[i]for k in x for j in k]))for i in(2,1,0)])(self.im[771:919,108+386*i:318+386*i]))for i in range(5)]
    def getStage(self):
        return self.select(IMG_STAGE,(1290,14,1348,60))+1
    def getPortrait(self):
        return[self.im[640:740,195+480*i:296+480*i]for i in range(3)]

def chooseFriend():
    if len(IMG_FRIEND)==0:
        doit('8',(1000,))
        return
    while True:
        for i in range(6):
            chk=Check()
            for img in IMG_FRIEND:
                if chk.tapOnCmp(img[1],delta=.015):
                    print('  Friend :',img[0])
                    try:
                        skillInfo[friendPos]={
                            'km':[[2,0,1],[1,0,0],[1,0,0]],
                            'cba':[[3,0,2],[3,0,0],[1,0,1]],
                            'ml':[[1,0,0],[1,0,0],[3,0,1]],
                        }[img[0][0:img[0].find('_')]]
                    except KeyError:
                        skillInfo[friendPos]=[[4,0,0],[4,0,0],[4,0,0]]
                    time.sleep(1)
                    return
            swipe((220,960,220,457))
            time.sleep(.2)
        doit('\xBAJ',(500,1000))

def draw():
    while True:
        doit('2',(20,))

def setSkillInfo(s):
    if s=='saber':#muzashi/modoredo/okita
        skillInfo[0]=[[1,0,0],[1,0,0],[3,5,0]]
        skillInfo[1]=[[1,0,0],[1,2,0],[1,0,0]]
        skillInfo[2]=[[1,0,0],[1,2,0],[3,5,0]]
    elif s=='archer':#arutoria/erio/atera
        skillInfo[0]=[[1,0,0],[4,0,0],[1,0,0]]
        skillInfo[1]=[[1,0,0],[3,0,0],[3,5,0]]
        skillInfo[2]=[[1,0,1],[1,0,2],[4,0,0]]
    elif s=='lancer':#ere/tamamo/jyanu
        skillInfo[0]=[[3,3,0],[1,0,0],[2,0,0]]
        skillInfo[1]=[[1,0,0],[3,0,0],[3,3,0]]
        skillInfo[2]=[[3,0,1],[1,0,0],[3,3,0]]
    elif s=='rider':#arutoria/asutorufo/maruta
        skillInfo[0]=[[3,0,1],[2,0,0],[1,0,0]]
        skillInfo[1]=[[1,0,0],[3,0,0],[1,0,0]]
        skillInfo[2]=[[3,0,0],[3,0,0],[3,0,0]]
    elif s=='caster':#malin/girugyameshi/mari
        skillInfo[0]=[[1,0,0],[3,4,0],[1,0,2]]
        skillInfo[1]=[[1,0,0],[1,0,0],[1,0,0]]
        skillInfo[2]=[[1,0,0],[1,0,0],[1,0,0]]
    elif s=='assassin':#kurobatera/hiroinx/jakku
        skillInfo[0]=[[1,0,0],[1,0,0],[3,6,0]]
        skillInfo[1]=[[2,0,0],[3,6,0],[4,0,0]]
        skillInfo[2]=[[3,6,0],[3,2,0],[3,0,3]]
    elif s=='ex':#hokusai/bb/hiroinx
        skillInfo[0]=[[1,0,0],[1,0,0],[1,0,0]]
        skillInfo[1]=[[1,2,0],[1,0,0],[4,0,0]]
        skillInfo[2]=[[3,6,0],[2,0,0],[1,0,0]]

def oneBattle(danger=(0,0,1)):
    turn,stage,stageTurn,servant=0,0,0,[0,1,2]
    while True:
        chk=Check()
        if chk.isTurnBegin():
            time.sleep(.3)
            turn+=1
            stage,stageTurn,skill,newPort=(lambda chk:(lambda x:[x,stageTurn+1if stage==x else 1])(chk.getStage())+[chk.isSkillReady(),chk.getPortrait()])(Check())
            print('    ',turn,stage,stageTurn,getTime())
            if stageTurn==1:
                doit('\xBB\xBD0'[danger[stage-1]]+'P',(50,500))
            if turn==1:
                port=newPort[:]
            else:
                for i in range(3):
                    if servant[i]<6and cv2.matchTemplate(newPort[i],port[i],cv2.TM_SQDIFF_NORMED)[0][0]>=.1:
                        port[i]=newPort[i]
                        servant[i]=max(servant)+1
            for i,j in[(i,j)for i in range(3)if servant[i]<6for j in range(3)if skill[i][j]and stage<<8|stageTurn>=skillInfo[servant[i]][j][0]<<8|skillInfo[servant[i]][j][1]]:
                doit((('A','S','D'),('F','G','H'),('J','K','L'))[i][j],(300,))
                if skillInfo[servant[i]][j][2]!=0:
                    doit(chr(skillInfo[servant[i]][j][1]+50),(300,))
                time.sleep(2)
                while not Check().isTurnBegin():
                    time.sleep(.2)
            hougu=(lambda x:[servant[i]<6and stage>=houguInfo[servant[i]][0]and any([x[j][i]for j in range(len(x))])for i in range(3)])((Check().isHouguReady(),Check().isHouguReady(),Check().isHouguReady()))
            doit(' ',(2700,))
            doit((lambda chk:(lambda h,c:([chr(i+54)for pri in{houguInfo[i][1]for i in servant if i<6}for i in range(3)if h[i]and houguInfo[servant[i]][1]==pri]if any(h)else[chr(j+49)for i in range(3)if c.count(i)>=3for j in range(5)if c[j]==i])+[chr(j+49)for i in(0,2,1,-1)for j in range(5)if c[j]==i])((lambda x,y:[x[i]^y[i]for i in range(3)])(hougu,chk.isHouguSealed()),chk.getABQ()))(Check())[:3],(80,80,10000))
        elif chk.isBattleOver():
            print('  Battle Finished',getTime())
            break
        elif chk.tapOnCmp(IMG_FAILED,rect=(277,406,712,553)):
            print('  Battle Failed',getTime())
            beep()
            return False
        else:
            time.sleep(.2)
    return True

def main(appleCount=0,appleKind=0,battleFunc=oneBattle,*args,**kwargs):
    apple=appleCount
    for i in rangeInf(1):
        doit('8',(1000,))
        if Check().isApEmpty():
            if apple==0:
                print('Ap Empty')
                press('\x12')
                return
            else:
                doit('W4K8'[appleKind]+'L',(400,1200))
                apple-=1
                print('Apple',appleCount-apple)
        print('  Battle',i,getTime())
        flush=True
        while True:
            chk=Check()
            if flush and chk.isNoFriend():
                doit('\xBAJ',(500,1000))
                flush=False
            if chk.isChooseFriend():
                break
            time.sleep(.2)
        chooseFriend()
        doit(' ',(1000,))
        if not battleFunc(*args,**kwargs):
            doit('VJ',(500,500))
        doit('        ',(200,200,200,200,200,200,200,200))
        while True:
            chk=Check()
            if chk.isBegin():
                break;
            chk.tapOnCmp(IMG_END,rect=(243,863,745,982))
            doit(' ',(200,))

